<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ—Ü–µ–ø—Ç</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .wrap { max-width: 920px; margin: 16px auto; padding: 0 12px }
    .ing { margin: 8px 0 16px }
    .ing li { margin: 2px 0 }
    .topbar { display:flex; align-items:center; gap:12px; margin:12px 0 }
    .back { color:#6D9580; text-decoration:none }
    select { padding:6px 8px; border-radius:8px; border:1px solid #D1D7D0; background: #FFFFFF; color: #3E3E40; }
    pre { white-space: pre-wrap }
    .recipe-image {
      width: 100%;
      max-width: 600px;
      height: auto;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
      <button id="deleteBtn" style="background: #C56A6A; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
    </div>
    <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h1>
    <div id="recipeImage"></div>
    <p id="desc"></p>

    <div class="topbar">
      <div><b>–ë–∞–∑–æ–≤—ã–µ –ø–æ—Ä—Ü–∏–∏:</b> <span id="basePortions">‚Äî</span></div>
      <label>–ü–æ—Ä—Ü–∏–∏ —Å–µ–π—á–∞—Å:
        <select id="portionSelect"></select>
      </label>
      <small id="date"></small>
    </div>

    <h3>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
    <ul class="ing" id="ingList"></ul>

    <h3>–®–∞–≥–∏</h3>
    <pre id="steps"></pre>
    <p id="tags"></p>
  </div>

  <script>
    // –ø–æ–ª—É—á–∞–µ–º id —Ä–µ—Ü–µ–ø—Ç–∞ –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    if (!id) {
      document.body.innerHTML = "<p>–ù–µ —É–∫–∞–∑–∞–Ω id —Ä–µ—Ü–µ–ø—Ç–∞.</p>";
    } else {
      loadRecipe(+id);
    }

    let recipe = null;
    let currentPortions = null;

    // –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ—Ü–µ–ø—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    async function loadRecipe(rid) {
      const res = await fetch(`/api/recipes/${rid}`);
      if (!res.ok) {
        document.body.innerHTML = "<p>–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>";
        return;
      }
      recipe = await res.json();

      // –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      document.getElementById("title").textContent = recipe.title;
      document.getElementById("desc").textContent = recipe.description || "";
      document.getElementById("steps").textContent = recipe.steps || "";
      document.getElementById("date").textContent = recipe.created_at || "";
      document.getElementById("basePortions").textContent = recipe.portions || 1;
      document.getElementById("tags").textContent = (recipe.tags||[]).map(t=>`#${t}`).join(" ");
      
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
      const imageContainer = document.getElementById("recipeImage");
      if (recipe.image) {
        imageContainer.innerHTML = `<img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">`;
      } else {
        imageContainer.innerHTML = '';
      }

      // —Å–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ü–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞
      const sel = document.getElementById("portionSelect");
      sel.innerHTML = "";
      const base = recipe.portions || 1;
      for (let p of [1,2,3,4,5,6,8,10,12]) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        if (p === base) opt.selected = true;
        sel.appendChild(opt);
      }
      currentPortions = base;
      sel.onchange = () => {
        currentPortions = parseInt(sel.value,10);
        renderIngredients(); // –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
      };

      renderIngredients();
    }

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ä—Ü–∏–π
    function renderIngredients() {
      const list = document.getElementById("ingList");
      list.innerHTML = "";
      const base = recipe.portions || 1;
      const factor = currentPortions / base; // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞

      for (const ing of (recipe.ingredients||[])) {
        let amount = (ing.amount ?? 0) * factor;

        // –æ–∫—Ä—É–≥–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
        if (["—à—Ç"].includes((ing.unit||"").toLowerCase())) {
          amount = Math.round(amount * 2) / 2; // –¥–æ 0.5
        } else if (["–≥","–≥—Ä","–º–ª"].includes((ing.unit||"").toLowerCase())) {
          amount = Math.round(amount); // –¥–æ —Ü–µ–ª–æ–≥–æ
        } else {
          amount = Math.round(amount * 10) / 10; // –¥–æ –¥–µ—Å—è—Ç—ã—Ö
        }

        const li = document.createElement("li");
        const unit = ing.unit ? " " + ing.unit : "";
        li.textContent = `${ing.name}: ${amount}${unit}`;
        list.appendChild(li);
      }
    }

    // —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞
    document.getElementById("deleteBtn").onclick = async () => {
      if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç "${recipe.title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
      }
      
      const res = await fetch(`/api/recipes/${recipe.id}`, {
        method: "DELETE"
      });
      
      if (res.ok) {
        alert("–†–µ—Ü–µ–ø—Ç —É–¥–∞–ª—ë–Ω");
        window.location.href = "/";
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞");
      }
    };
  </script>
</body>
</html>
