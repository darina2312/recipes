<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Рецепт</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .wrap { max-width: 920px; margin: 16px auto; padding: 0 12px }
    .ing { margin: 8px 0 16px }
    .ing li { margin: 2px 0 }
    .topbar { display:flex; align-items:center; gap:12px; margin:12px 0 }
    .back { color:#6D9580; text-decoration:none }
    select { padding:6px 8px; border-radius:8px; border:1px solid #D1D7D0; background: #FFFFFF; color: #3E3E40; }
    pre { white-space: pre-wrap }
    .recipe-image {
      width: 100%;
      max-width: 600px;
      height: auto;
      border-radius: 12px;
      margin: 16px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="/">← Назад к списку</a>
    <h1 id="title">Загрузка…</h1>
    <div id="recipeImage"></div>
    <p id="desc"></p>

    <div class="topbar">
      <div><b>Базовые порции:</b> <span id="basePortions">—</span></div>
      <label>Порции сейчас:
        <select id="portionSelect"></select>
      </label>
      <small id="date"></small>
    </div>

    <h3>Ингредиенты</h3>
    <ul class="ing" id="ingList"></ul>

    <h3>Шаги</h3>
    <pre id="steps"></pre>
    <p id="tags"></p>
  </div>

  <script>
    // получаем id рецепта из адресной строки
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    if (!id) {
      document.body.innerHTML = "<p>Не указан id рецепта.</p>";
    } else {
      loadRecipe(+id);
    }

    let recipe = null;
    let currentPortions = null;

    // загружает рецепт с сервера и показывает на странице
    async function loadRecipe(rid) {
      const res = await fetch(`/api/recipes/${rid}`);
      if (!res.ok) {
        document.body.innerHTML = "<p>Рецепт не найден.</p>";
        return;
      }
      recipe = await res.json();

      // заполняем поля на странице
      document.getElementById("title").textContent = recipe.title;
      document.getElementById("desc").textContent = recipe.description || "";
      document.getElementById("steps").textContent = recipe.steps || "";
      document.getElementById("date").textContent = recipe.created_at || "";
      document.getElementById("basePortions").textContent = recipe.portions || 1;
      document.getElementById("tags").textContent = (recipe.tags||[]).map(t=>`#${t}`).join(" ");
      
      // показываем изображение если есть
      const imageContainer = document.getElementById("recipeImage");
      if (recipe.image) {
        imageContainer.innerHTML = `<img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">`;
      } else {
        imageContainer.innerHTML = '';
      }

      // создаём список порций для выбора
      const sel = document.getElementById("portionSelect");
      sel.innerHTML = "";
      const base = recipe.portions || 1;
      for (let p of [1,2,3,4,5,6,8,10,12]) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        if (p === base) opt.selected = true;
        sel.appendChild(opt);
      }
      currentPortions = base;
      sel.onchange = () => {
        currentPortions = parseInt(sel.value,10);
        renderIngredients(); // пересчитываем ингредиенты
      };

      renderIngredients();
    }

    // показывает ингредиенты с учётом выбранного количества порций
    function renderIngredients() {
      const list = document.getElementById("ingList");
      list.innerHTML = "";
      const base = recipe.portions || 1;
      const factor = currentPortions / base; // коэффициент для пересчёта

      for (const ing of (recipe.ingredients||[])) {
        let amount = (ing.amount ?? 0) * factor;

        // округляем в зависимости от единицы измерения
        if (["шт"].includes((ing.unit||"").toLowerCase())) {
          amount = Math.round(amount * 2) / 2; // до 0.5
        } else if (["г","гр","мл"].includes((ing.unit||"").toLowerCase())) {
          amount = Math.round(amount); // до целого
        } else {
          amount = Math.round(amount * 10) / 10; // до десятых
        }

        const li = document.createElement("li");
        const unit = ing.unit ? " " + ing.unit : "";
        li.textContent = `${ing.name}: ${amount}${unit}`;
        list.appendChild(li);
      }
    }
  </script>
</body>
</html>
